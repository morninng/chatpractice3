#!/usr/bin/env node
var debug = require('debug')('chat3');
var app = require('../app');
app.set('port', process.env.PORT || 3000);


var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});


var io = require('socket.io').listen(server);
io.set('origins',"*:*");



(function(){


//var chat_infra = io.of("/chat_infra");
io.on('connection', function(socket){
  console.log("chat infra connection");

  socket.on('disconnect', function(){
    console.log('user disconnected');
  });
  socket.on('set_name', function(data){
    console.log('set name called' + data.name);
    console.log(socket.id);
    socket.username = data.name;
    //socket.emit('setname_done', {name:data.name}); // sent all other than you
 //   socket.broadcast.emit('setname_done', {name:data.name}); // sent all other than you
    io.to(socket.id).emit('setname_done', {name:data.name});
  });
  socket.on('join_room', function(room){
    socket.join(room.name);
    io.sockets.in(room.name).emit('user_entered', {name:socket.username});
  });

  socket.on('chat_msg', function(data){
    console.log('chat message called' + data.message);
    console.log(socket.id);
    if(socket.username){
      data = {
        username: socket.username,
        message: data.message
      }
    }else{
      data = {
        message: data.message
      }
    }
    io.sockets.in(socket.room).emit('msg_server', data);
  });
});


}());
